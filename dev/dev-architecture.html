<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Architecture - Alternative Haskell Infrastructure for Nixpkgs</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Architecture";
    var mkdocs_page_input_path = "dev/dev-architecture.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href="../index.html" class="icon icon-home"> Alternative Haskell Infrastructure for Nixpkgs</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../index.html">Introduction</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../motivation.html">Motivation</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../architecture.html">Architecture</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Tutorials</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../tutorials/getting-started.html">Getting Started</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../tutorials/getting-started-flakes.html">Getting started with Flakes</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../tutorials/development.html">Creating a development environment</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../tutorials/clean-git.html">Sourcing files only part of git repository using cleanGit</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../tutorials/source-repository-hashes.html">Handling git repositories in projects</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../tutorials/pkg-map.html">Mapping non-Haskell dependencies to Nixpkgs</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../tutorials/hackage-stackage.html">Bumping Hackage and Stackage snapshots</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../tutorials/materialization.html">Materialization: Speeding up Nix evaluation</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../tutorials/cross-compilation.html">Cross-compiling your project</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../tutorials/coverage.html">Generating coverage information</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Reference</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../reference/supported-ghc-versions.html">Supported GHC versions</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../reference/commands.html">Command-line tools</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../reference/library.html">Haskell.nix Library</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../reference/modules.html">Module options</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../troubleshooting.html">Troubleshooting</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Templates / Abstraction</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../iohk-nix.html">IOHKs nix library</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Dev Notes</span></p>
                <ul class="current">
                    <li class="toctree-l1 current"><a class="reference internal current" href="dev-architecture.html">Architecture</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#packages">Packages</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#plans">Plans</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#package-sets-of-derivations">Package Sets (of derivations)</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#component-builder">Component builder</a>
    </li>
        </ul>
    </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="installing-nix-tools.html">Installing nix-tools</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="manually-generating-nix-expressions.html">Manually generating Nix expressions</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="maintainer-scripts.html">Maintainer Scripts</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="nixpkgs-pin.html">Nixpkgs Pin</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="removing-with-package-wrapper.html">Removing withPackage wrapper</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="tests.html">Test Suite</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="adding-new-ghc.html">Adding a new GHC version</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="coverage.html">Coverage</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../changelog.html">ChangeLog</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">Alternative Haskell Infrastructure for Nixpkgs</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
    
      
        
          <li>Dev Notes &raquo;</li>
        
      
    
    <li>Architecture</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/input-output-hk/haskell.nix/edit/master/docs/dev/dev-architecture.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  
  <hr/>
</div>

          <div role="main">
            <div class="section">
              
                <h1 id="developer-architecture-overview">Developer Architecture Overview<a class="headerlink" href="#developer-architecture-overview" title="Permanent link">&para;</a></h1>
<p>This shall give a sufficiently good overview over the haskell.nix
ideas, such that a new developer can navigate around without too
much trouble.</p>
<h2 id="packages">Packages<a class="headerlink" href="#packages" title="Permanent link">&para;</a></h2>
<p><code>haskell.nix</code> is centered around packages (haskell package
descriptions as nix-expressions). These are generated by
<code>cabal-to-nix</code> from the <code>nix-tools</code> package. <code>stack-to-nix</code> and
<code>plan-to-nix</code> will delegate the transformation of cabal packages to
nix expressions to the same code that <code>cabal-to-nix</code> uses.</p>
<p>These packages will look similar to the following:</p>
<pre><code class="language-nix">{ system, compiler, flags, pkgs, hsPkgs, pkgconfPkgs, ... }:
{
  flags = {};
  package = { ... };
  components = {
    &quot;library&quot; = { depends = [ ... ]; };
    exes = { &quot;...&quot; = { depends = [ ... ]; }; ... };
    sublibs = { &quot;...&quot; = { depends = [ ... ]; }; ... };
    tests = { &quot;...&quot; = { depends = [ ... ]; }; ... };
    benchmarks = { &quot;...&quot; = { depends = [ ... ]; }; ... };
  };
};
</code></pre>
<p>The exact specification can be found in <code>modules/package.nix</code>.</p>
<h2 id="plans">Plans<a class="headerlink" href="#plans" title="Permanent link">&para;</a></h2>
<p>Packages (unless specified directly in the <code>packages</code> attribute of the
module) usually come from a plan. A plan is either a Stackage snapshot
(nightly or LTS) or a build plan as produced by <code>cabal</code>.</p>
<p>Plan files usually look like the following:</p>
<pre><code class="language-nix">hackage:
{
  packages = {
    &quot;$pkg&quot;.revision = hackage.$pkg.$version.revisions.default;
    &quot;$pkg&quot;.flags = { flag1 = true; flag2 = false; ... };
    ...
  };
  compiler = {
    version = &quot;8.4.4&quot;;
      nix-name = &quot;ghc844&quot;;
      packages = {
        &quot;binary&quot; = &quot;0.8.5.1&quot;;
    ...
      };
   };
}
</code></pre>
<p>This provides enough information about the compiler, what packages the
compiler ships with and the packages we want to use in our plan.</p>
<p>This revision and flag information will be inlined into a list of
packages in <code>config.packages</code> in <code>modules/plan.nix</code>.  Thus
<code>config.packages</code> will only contains packages as described in the
previous section.</p>
<h2 id="package-sets-of-derivations">Package Sets (of derivations)<a class="headerlink" href="#package-sets-of-derivations" title="Permanent link">&para;</a></h2>
<p>We finally tie this all together in <code>package-set.nix</code> where we use
<code>modules/component-driver.nix</code> to produce the derivations for each
packages component to produce the final <code>config.hsPkgs</code> value.</p>
<p>There is also a <code>modules/compat-driver.nix</code> that should produce the
same packageset to be used with the stock haskell infrastructure in
nixpkgs (<em>This has undergone substantially less testing</em>).</p>
<h3 id="component-builder">Component builder<a class="headerlink" href="#component-builder" title="Permanent link">&para;</a></h3>
<p>To prevent depending on multiple instances of the same libraries, the
component builder will try to build every package from scratch and
rely as little as possible on packages that are shipped with the GHC
distribution. The exceptions are packages that are known to not be
reinstallable. See <code>config.nonReinstallablePkgs</code>.</p>
<p>The component builder can be found in <code>modules/component-driver.nix</code>
and <code>builder/default.nix</code>. The component-driver will ensure that we do
not try to rebuild non-reinstallable packages, and call the
<code>builder/default.nix</code> on each package in <code>config.packages</code> to produce
<code>config.hsPkgs</code>.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="installing-nix-tools.html" class="btn btn-neutral float-right" title="Installing nix-tools">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../iohk-nix.html" class="btn btn-neutral" title="IOHKs nix library"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/input-output-hk/haskell.nix/" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../iohk-nix.html" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="installing-nix-tools.html" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
