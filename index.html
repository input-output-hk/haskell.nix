<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="None">
  
  <link rel="shortcut icon" href="img/favicon.ico">
  <title>Introduction - Alternative Haskell Infrastructure for Nixpkgs</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="css/theme.css" type="text/css" />
  <link rel="stylesheet" href="css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Introduction";
    var mkdocs_page_input_path = "index.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="js/jquery-2.1.1.min.js" defer></script>
  <script src="js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="." class="icon icon-home"> Alternative Haskell Infrastructure for Nixpkgs</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="./search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1 current">
		
    <a class="current" href=".">Introduction</a>
    <ul class="subnav">
            
    <li class="toctree-l2"><a href="#haskellnix">haskell.nix</a></li>
    
        <ul>
        
            <li><a class="toctree-l3" href="#motivation">Motivation</a></li>
        
        </ul>
    

    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="architecture/">Architecture</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">User Guide</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="user-guide/">General</a>
                </li>
                <li class="">
                    
    <a class="" href="user-guide-stack/">Stack Projects</a>
                </li>
                <li class="">
                    
    <a class="" href="user-guide-cabal/">Cabal Proejcts</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Templates / Abstraction</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="iohk-nix/">IOHKs nix library</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Dev Notes</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="dev-architecture/">Architecture</a>
                </li>
                <li class="">
                    
    <a class="" href="removing-with-package-wrapper/">Removing withPackage wrapper</a>
                </li>
                <li class="">
                    
    <a class="" href="maintainer-scripts/">Maintainer Scripts</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href=".">Alternative Haskell Infrastructure for Nixpkgs</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".">Docs</a> &raquo;</li>
    
      
    
    <li>Introduction</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/input-output-hk/haskell.nix/edit/master/docs/index.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="haskellnix">haskell.nix</h1>
<p>haskell.nix is an alternative Haskell infrastructure for nixpkgs. See
<a href="https://nixos.org/nixpkgs/manual/#users-guide-to-the-haskell-infrastructure">Nixpkgs current Users' Guide to Haskell Infrastructure</a> for comparison.</p>
<h2 id="motivation">Motivation</h2>
<p>Why do we need another Haskell infrastructure for nix?  Doesn't nixpkgs
provide a sufficiently good Haskell infrastructure already?  These are
good questions.  And it boils down to the following reasons for us to
embark on a new infrastructure:</p>
<ul>
<li>first class support for cross compilation</li>
<li>first class support for package sets</li>
<li>component level control when building packages</li>
<li>reduction of <code>dontCheck</code> for cyclic dependencies</li>
<li>reducing build times by building libraries and tests in parallel</li>
<li>more logic encoded in nix expressions</li>
<li>decoupling of Haskell and nixpkgs</li>
</ul>
<h3 id="cross-compilation">cross compilation</h3>
<p><code>nixpkgs</code> has quite good support for cross compilation, however the
Haskell infrastructure suffers from the fact that it heavily relies on
the <code>cabal2nix</code> tool.  <code>cabal2nix</code> (as well as tools that depend on it
like <code>stack2nix</code>) flattens the <code>.cabal</code> file at conversion time to a
given os/arch/flags configuration.  Thus to make cross compilation
work with <code>cabal2nix</code> you will have to generate a separate <code>nix</code>
expression for each configuration.  This becomes a major maintenance
burden over time.  Therefore the tooling that translates cabal files
into nix-expressions for use with Haskell.nix retains the full
conditional tree from the cabal file and exposes it to <code>nix</code>.  In
addition it will also expose the <code>build-type</code> value, which allows us
to cache the <code>Setup.hs</code> for build-type simple and not have to rebuild
it every time.</p>
<h3 id="package-sets">package sets</h3>
<p>We often rely on either package sets as provided by stackage or
computed by cabal.  <code>nixpkgs</code> provides it's own curated package set
which might or might not work for the projects we work on.
<code>stack2nix</code> tries to solve this issue, here we go one step further and
provide the infrastructure to allow any form of package set.</p>
<h3 id="component-level-control">component level control</h3>
<p>The Haskell builder in <code>nixpkgs</code> provides control over executables and
libraries, to build a specific executable only however is rather
tricky to do.  This also leads to the cyclic dependencies issue.</p>
<h3 id="cyclic-dependencies">cyclic dependencies</h3>
<p>The Haskell builder in <code>nixpkgs</code> exposes packages at the
package level. If packages mutually depend on each other through tests
and libraries, this leads to cyclic dependencies that nix can't resolve. By
exposing the components to nix as separate derivations this will only
occur if you have mutually dependent components.</p>
<h3 id="build-times">build times</h3>
<p>The Haskell builder in nixpkgs build package sequentially, first the
library than the executables and finally the tests.  It then executes
the tests before the package is considered done.  The upshot of this
is that packages are only considered done if the test-suites
passed.  The downside is that if you have to compile multiple packages
the likelihood of them failing is low, you have unnecessarily
serialized you build.  In a more aggressive setting libraries could
start building as early as their dependent libraries are built.  Of
course they will have to be invalidated later should the test-suites
of their dependencies fail, but this way we can make use of parallel
building.  In an ideal scenario this will reduce build times close to
the optimum.</p>
<h3 id="more-logic-in-nix">more logic in nix</h3>
<p>The <code>cabal2nix</code> tool has a resolver that resolves system dependencies
and licenses to values in <code>nixpkgs</code>.  This logic ends up being a simple
dictionary lookup and therefore can be a simple nix expression. This also
offloads some of the work the cabal to nix translation tool needs to
do into nix, and as such if changes are necessary (or needed to be
performed ad hoc) there is no need to rebuild the conversion tool and
subsequently mark every derived expression as out of date.</p>
<h3 id="decoupling">decoupling</h3>
<p>Finally, by treating Haskell.nix and nixpkgs as separate entities we
can decouple the Haskell packages and infrastructure from the nixpkgs
package set, and rely on it to provide us with system packages while
staying up to date with Haskell packages from hackage while retaining
a stable (or known to be good) nixpkgs revision.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="architecture/" class="btn btn-neutral float-right" title="Architecture">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/input-output-hk/haskell.nix/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
      
        <span style="margin-left: 15px"><a href="architecture/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '.';</script>
    <script src="js/theme.js" defer></script>
      <script src="search/main.js" defer></script>

</body>
</html>

<!--
MkDocs version : 1.0.4
-->
